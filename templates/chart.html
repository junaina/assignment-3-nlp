<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>{{ symbol }} Forecast</title>
    <script src="{{ url_for('static', filename='plotly.min.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}" />
    <style>
      #chart{height:520px}
      .toolbar{display:flex;gap:8px;align-items:center;margin:8px 0 16px}
      .toolbar label{font-weight:600}
    </style>
  </head>
  <body>
    <div class="container">
      <a href="{{ url_for('index') }}">&larr; Back</a>
      <h2>{{ symbol }} — {{ horizon }}h ({{ metrics.model }})</h2>
      {% if metrics.rmse is not none %}
      <p>Validation — RMSE: {{ '%.3f'|format(metrics.rmse) }}, MAE: {{ '%.3f'|format(metrics.mae) }}</p>
      {% endif %}

      <!-- ▼▼ NEW toolbar with symbol + horizon dropdowns ▼▼ -->
      <div class="toolbar">
        <label for="symSel">Symbol</label>
        <select id="symSel">
          {% for s in symbols %}
            <option value="{{ s }}" {% if s==symbol %}selected{% endif %}>{{ s }}</option>
          {% endfor %}
        </select>

        <label for="horSel">Horizon</label>
        <select id="horSel">
          {% for h in [1,3,24,72] %}
            <option value="{{ h }}" {% if h==horizon %}selected{% endif %}>{{ h }}h</option>
          {% endfor %}
        </select>

        <button id="goBtn">Go</button>
      </div>
      <!-- ▲▲ NEW toolbar ▲▲ -->

      <div id="chart"></div>
    </div>

    <!-- Data blobs BEFORE plotting -->
    <script id="hist-json" type="application/json">{{ hist | tojson | safe }}</script>
    <script id="fc-json"   type="application/json">{{ forecast | tojson | safe }}</script>
    <script id="err-json"  type="application/json">{{ error | tojson | safe }}</script>

    <script>
      // small helper to rebuild the /chart URL
      function gotoChart(sym, horizon) {
        const u = new URL("{{ url_for('chart') }}", window.location.origin);
        u.searchParams.set("symbol", sym);
        u.searchParams.set("horizon", String(horizon));
        window.location.href = u.toString();
      }

      // wire the toolbar
      (function wireToolbar(){
        const symSel = document.getElementById("symSel");
        const horSel = document.getElementById("horSel");
        const goBtn  = document.getElementById("goBtn");

        goBtn.addEventListener("click", () => gotoChart(symSel.value, horSel.value));
        symSel.addEventListener("change", () => gotoChart(symSel.value, horSel.value));
        horSel.addEventListener("change", () => gotoChart(symSel.value, horSel.value));
      })();
    </script>

    <script>
      (function () {
        if (!window.Plotly) { alert("Plotly failed to load"); return; }
        try {
          const hist = JSON.parse(document.getElementById("hist-json").textContent);
          const fc   = JSON.parse(document.getElementById("fc-json").textContent);
          const err  = JSON.parse(document.getElementById("err-json").textContent || "{}");

          const validHist = hist && Array.isArray(hist.x) && hist.x.length > 0;
          const validFc   = fc   && Array.isArray(fc.x)   && fc.x.length   > 0 && Array.isArray(fc.y);
          const validErr  = err  && Array.isArray(err.x)  && err.x.length  > 0 && Array.isArray(err.pct);

          const traces = [];

          if (validHist) {
            traces.push({ type:"candlestick", x:hist.x, open:hist.open, high:hist.high, low:hist.low, close:hist.close, name:"History" });
          } else {
            traces.push({ type:"scatter", y:[1,3,2,4], name:"Demo" });
          }

          if (validFc) {
            traces.push({ type:"scatter", mode:"lines+markers", x:fc.x, y:fc.y, name:"Forecast" });
          }

          if (validErr) {
            traces.push({ type:"bar", x:err.x, y:err.pct, name:"% Error (actual - pred)", yaxis:"y2", opacity:0.35 });
          }

          Plotly.newPlot("chart", traces, {
            title: "{{ symbol }} — next {{ horizon }}h",
            xaxis: { title: "Time" },
            yaxis: { title: "Price" },
            yaxis2: { title: "% Error", overlaying: "y", side: "right", showgrid: false, zeroline: true },
            barmode: "overlay",
            legend: { orientation: "h" },
            margin: { l:60, r:60, t:40, b:40 }
          });
        } catch (e) { console.error(e); alert("Error plotting: " + e.message); }
      })();
    </script>
  </body>
</html>
