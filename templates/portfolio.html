<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Portfolio</title>
  <script src="{{ url_for('static', filename='plotly.min.js') }}"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
  <style>
    .toolbar { display:flex; gap:8px; align-items:center; margin-bottom: 8px; }
    #equity { height: 520px; }
    table { border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; }
  </style>
</head>
<body>
  <div class="container">
    <a href="{{ url_for('index') }}">&larr; Back</a>
    <h2>Simulated Portfolio</h2>
    <div class="toolbar">
      <label>Symbol</label>
      <select id="symbol">
        {% for s in symbols %}
          <option value="{{ s }}" {% if s==default_symbol %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
      <label>Threshold (%)</label>
      <input id="thr" type="number" step="0.1" value="0.5" style="width:80px">
      <button id="run">Run Backtest</button>
    </div>

    <div id="equity"></div>
    <div id="empty" style="display:none;">No data to backtest. Make sure youâ€™ve run backfill + evaluate for this symbol.</div>

    <h3>Trades</h3>
    <table id="trades">
      <thead><tr><th>Time</th><th>Side</th><th>Qty</th><th>Price</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    async function runBacktest(symbol, thr){
      const url = `{{ url_for('api_portfolio_backtest') }}?symbol=${encodeURIComponent(symbol)}&thr=${encodeURIComponent(thr)}`;
      const r = await fetch(url);
      if (!r.ok) throw new Error("backtest api failed");
      return await r.json();
    }

    function drawEquity(d){
      const chart = document.getElementById("equity");
      const empty = document.getElementById("empty");
      if (!d.x || !d.x.length){
        Plotly.purge(chart);
        empty.style.display = "block";
        return;
      }
      empty.style.display = "none";
      Plotly.newPlot("equity", [{type:"scatter", x:d.x, y:d.equity, name:"Equity"}],
        { xaxis:{title:"Time"}, yaxis:{title:"Equity ($)"}, margin:{l:60,r:20,t:20,b:40} });
    }

    function fillTrades(d){
      const tbody = document.querySelector("#trades tbody");
      tbody.innerHTML = "";
      (d.trades || []).forEach(([ts, side, qty, price]) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${ts}</td><td>${side}</td><td>${qty.toFixed(4)}</td><td>${price.toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
    }

    (function init(){
      const symSel = document.getElementById("symbol");
      const thrInput = document.getElementById("thr");
      const runBtn = document.getElementById("run");

      async function go(){
        try{
          const d = await runBacktest(symSel.value, parseFloat(thrInput.value || "0.5"));
          drawEquity(d);
          fillTrades(d);
        }catch(e){
          console.error(e);
          alert("Backtest failed");
        }
      }

      runBtn.addEventListener("click", go);
      go(); // initial
    })();
  </script>
</body>
</html>
